{{=<% %>=}}import { useOktaAuth } from '@okta/okta-react';

/**
 * API client hook with automatic JWT token injection
 *
 * Provides fetch wrapper that automatically includes Okta JWT token
 * in Authorization header for authenticated API requests
 *
 * Usage:
 * ```tsx
 * const api = useApiClient();
 * const data = await api.get('/protected/user/profile');
 * ```
 */
export function useApiClient() {
  const { authState } = useOktaAuth();

  const apiBase = import.meta.env.VITE_API_BASE || 'http://localhost:8080';

  async function request<T = unknown>(
    path: string,
    options: RequestInit = {}
  ): Promise<T> {
    try {
      // Get access token from Okta auth state
      const token = authState?.accessToken?.accessToken;

      if (!token) {
        throw new Error('No access token available. Please log in.');
      }

      // Build full URL
      const url = `${apiBase}${path}`;

      // Add Authorization header
      const headers = {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
        ...options.headers,
      };

      // Make request
      const response = await fetch(url, {
        ...options,
        headers,
      });

      // Handle errors
      if (!response.ok) {
        const errorText = await response.text();
        let errorMessage = `API error: ${response.status}`;

        try {
          const errorJson = JSON.parse(errorText);
          errorMessage = errorJson.message || errorJson.error || errorMessage;
        } catch {
          errorMessage = errorText || errorMessage;
        }

        throw new Error(errorMessage);
      }

      // Parse JSON response
      return await response.json();
    } catch (error) {
      console.error('API request failed:', error);
      throw error;
    }
  }

  return {
    get: <T = unknown>(path: string, options?: RequestInit) =>
      request<T>(path, { ...options, method: 'GET' }),

    post: <T = unknown>(path: string, body?: unknown, options?: RequestInit) =>
      request<T>(path, {
        ...options,
        method: 'POST',
        body: body ? JSON.stringify(body) : undefined,
      }),

    put: <T = unknown>(path: string, body?: unknown, options?: RequestInit) =>
      request<T>(path, {
        ...options,
        method: 'PUT',
        body: body ? JSON.stringify(body) : undefined,
      }),

    delete: <T = unknown>(path: string, options?: RequestInit) =>
      request<T>(path, { ...options, method: 'DELETE' }),

    patch: <T = unknown>(path: string, body?: unknown, options?: RequestInit) =>
      request<T>(path, {
        ...options,
        method: 'PATCH',
        body: body ? JSON.stringify(body) : undefined,
      }),
  };
}
<%={{ }}=%>
